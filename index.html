<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="description" content="Athena - A playful, native-feeling learning PWA that grows with your child from ages 2-17" />
  <meta name="theme-color" content="#60A5FA" />
  <title>Athena - Learning Adventure</title>

  <!-- Tailwind CSS (required) -->
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <!-- PWA Manifest (data URL) -->
  <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkF0aGVuYSIsCiAgInNob3J0X25hbWUiOiAiQXRoZW5hIiwKICAic3RhcnRfdXJsIjogIi4iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiNmOGZhZmMiLAogICJ0aGVtZV9jb2xvciI6ICIjNjBBNUZBIiwKICAiZGVzY3JpcHRpb24iOiAiQXRoZW5hIC0gYSBwbGF5ZnVsLCBuYXRpdmUtZmVlbGluZyBsZWFybmluZyBQV0EiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWwsPHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHdpZHRoPScxOTInIGhlaWdodD0nMTkyJyB2aWV3Qm94PScwIDAgMTkyIDE5Mic+PGRlZnM+PGxpbmVhckdyYWRpZW50IGlkPSdnJyB4MT0nMCUnIHkxPScwJScgeDI9JzEwMCUnIHkyPScxMDAlJz48c3RvcCBvZmZzZXQ9JzAlJyBzdG9wLWNvbG9yPScjNjBBNUZBJy8+PHN0b3Agb2Zmc2V0PScxMDAlJyBzdG9wLWNvbG9yPScjRkI3MThGJy8+PC9saW5lYXJHcmFkaWVudD48L2RlZnM+PHJlY3Qgd2lkdGg9JzE5MicgaGVpZ2h0PScxOTInIHJ4PSc0MCcgZmlsbD0ndXJsKCNnKScvPjx0ZXh0IHg9JzUwJScgeT0nNTAlJyBmb250LWZhbWlseT0nRnJlZG9rYScgZm9udC1zaXplPSc5MCcgZm9udC13ZWlnaHQ9JzcwMCcgZmlsbD0nd2hpdGUnIHRleHQtYW5jaG9yPSdtaWRkbGUnIGRvbWluYW50LWJhc2VsaW5lPSdtaWRkbGUnPkE8L3RleHQ+PC9zdmc+IiwKICAgICAgInNpemVzIjogIjE5MngxOTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIgogICAgfSwKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWwsPHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHdpZHRoPSc1MTInIGhlaWdodD0nNTEyJyB2aWV3Qm94PScwIDAgNTEyIDUxMic+PGRlZnM+PGxpbmVhckdyYWRpZW50IGlkPSdnJyB4MT0nMCUnIHkxPScwJScgeDI9JzEwMCUnIHkyPScxMDAlJz48c3RvcCBvZmZzZXQ9JzAlJyBzdG9wLWNvbG9yPScjNjBBNUZBJy8+PHN0b3Agb2Zmc2V0PScxMDAlJyBzdG9wLWNvbG9yPScjRkI3MThGJy8+PC9saW5lYXJHcmFkaWVudD48L2RlZnM+PHJlY3Qgd2lkdGg9JzUxMicgaGVpZ2h0PSc1MTInIHJ4PScxMDAnIGZpbGw9J3VybCgjZyknLz48dGV4dCB4PSc1MCUnIHk9JzUwJScgZm9udC1mYW1pbHk9J0ZyZWRva2EnIGZvbnQtc2l6ZT0nMjQwJyBmb250LXdlaWdodD0nNzAwJyBmaWxsPSd3aGl0ZScgdGV4dC1hbmNob3I9J21pZGRsZScgZG9taW5hbnQtYmFzZWxpbmU9J21pZGRkbGUnPkE8L3RleHQ+PC9zdmc+IiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIgogICAgfQogIF0KfQ==" />

  <style>
    :root{
      --bg1:#f8fbff;
      --bg2:#fff7fb;
      --bg3:#fff9e8;
      --card: rgba(255,255,255,.85);
      --stroke: rgba(15, 23, 42, .08);
      --shadow: 0 18px 50px rgba(2, 6, 23, .12);
      --shadow-soft: 0 10px 30px rgba(2, 6, 23, .10);
      --accent: #60A5FA;
      --accent2:#FB7185;
      --accent3:#34D399;
      --ink: #0f172a;
    }

    *{ font-family: 'Fredoka', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }

    body{
      background:
        radial-gradient(1200px 800px at 10% 0%, rgba(96,165,250,.25), transparent 60%),
        radial-gradient(1200px 800px at 90% 20%, rgba(251,113,133,.20), transparent 60%),
        radial-gradient(900px 700px at 50% 100%, rgba(52,211,153,.18), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2) 45%, var(--bg3));
      min-height: 100vh;
      overflow-x: hidden;
      color: var(--ink);
    }

    /* iOS-like cards */
    .glass{
      background: var(--card);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow-soft);
    }

    .pill{
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.75);
      backdrop-filter: blur(12px);
    }

    /* native-ish button */
    .btn{
      border-radius: 16px;
      padding: 12px 16px;
      font-weight: 700;
      transition: transform .12s ease, filter .12s ease;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{ transform: scale(.98); filter: brightness(.98); }

    .btn-primary{ background: linear-gradient(135deg, var(--accent), #7C3AED); color: #fff; box-shadow: 0 12px 30px rgba(96,165,250,.35); }
    .btn-pink{ background: linear-gradient(135deg, var(--accent2), #f97316); color:#fff; box-shadow: 0 12px 30px rgba(251,113,133,.30); }
    .btn-green{ background: linear-gradient(135deg, var(--accent3), #22c55e); color:#fff; box-shadow: 0 12px 30px rgba(52,211,153,.28); }
    .btn-gray{ background: rgba(15,23,42,.08); color: rgba(15,23,42,.85); }

    /* tab bar */
    .tabbar{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      padding: 10px 12px calc(env(safe-area-inset-bottom) + 10px);
      z-index: 40;
    }

    .tabbar-inner{
      max-width: 980px;
      margin: 0 auto;
      border-radius: 22px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.82);
      backdrop-filter: blur(18px);
      box-shadow: var(--shadow);
      display: grid;
      grid-template-columns: repeat(4, 1fr);
    }

    .tab{
      padding: 10px 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      color: rgba(15,23,42,.55);
      transition: .15s ease;
      border-radius: 18px;
      margin: 6px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }

    .tab.active{
      background: linear-gradient(135deg, rgba(96,165,250,.18), rgba(251,113,133,.12));
      color: rgba(15,23,42,.92);
      box-shadow: inset 0 0 0 1px rgba(96,165,250,.22);
    }

    /* modal */
    .modal{
      position: fixed;
      inset: 0;
      z-index: 80;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding: 10px;
    }

    .modal-overlay{
      position:absolute;
      inset:0;
      background: rgba(2,6,23,.45);
      backdrop-filter: blur(2px);
      -webkit-backdrop-filter: blur(2px);
    }

    .sheet{
      position: relative;
      width: 100%;
      max-width: 980px;
      max-height: 92vh;
      border-radius: 26px;
      overflow: hidden;
      transform: translateY(14px);
      animation: sheetIn .22s ease-out forwards;
    }

    @keyframes sheetIn{
      from{ transform: translateY(22px); opacity: .0; }
      to{ transform: translateY(0); opacity: 1; }
    }

    .sheet-header{
      display:flex;
      align-items:center;
      justify-content: space-between;
      padding: 16px 16px 10px;
      background: rgba(255,255,255,.75);
      border-bottom: 1px solid var(--stroke);
    }

    .sheet-body{ padding: 16px; overflow: auto; max-height: calc(92vh - 64px); }

    /* small shake for feedback */
    @keyframes nudge{ 0%,100%{ transform: translateX(0);} 20%{transform: translateX(-4px);} 40%{transform: translateX(4px);} 60%{transform: translateX(-3px);} 80%{transform: translateX(3px);} }
    .shake{ animation: nudge .35s ease; }

    /* particle */
    .particle{ position: fixed; pointer-events:none; z-index: 999; }
    @keyframes pop{ 0%{ transform: translate(-50%,-50%) scale(.4); opacity: 0;} 30%{opacity:1;} 100%{ transform: translate(-50%,-90%) scale(1.1); opacity: 0;} }

    /* Tea Party table */
    .table-wrap{
      position: relative;
      width: 100%;
      max-width: 720px;
      margin: 0 auto;
      aspect-ratio: 1.7;
      border-radius: 28px;
      background:
        radial-gradient(500px 300px at 50% 50%, rgba(255,255,255,.75), rgba(255,255,255,.35)),
        linear-gradient(135deg, rgba(96,165,250,.18), rgba(251,113,133,.16), rgba(52,211,153,.14));
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow-soft);
      overflow: hidden;
    }

    .table-oval{
      position:absolute;
      inset: 14% 10%;
      border-radius: 999px;
      background:
        radial-gradient(120px 120px at 30% 25%, rgba(255,255,255,.7), transparent 60%),
        radial-gradient(160px 140px at 70% 75%, rgba(255,255,255,.5), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.65), rgba(255,255,255,.25));
      border: 1px solid rgba(15,23,42,.08);
    }

    .guest{
      position:absolute;
      width: 32%;
      max-width: 240px;
      min-width: 160px;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      gap: 10px;
    }

    .guest .avatar{
      width: 64px; height: 64px;
      border-radius: 18px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(255,255,255,.8);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow-soft);
      font-size: 34px;
    }

    .plate{
      width: 120px;
      height: 70px;
      border-radius: 999px;
      background: rgba(255,255,255,.8);
      border: 1px solid var(--stroke);
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 6px;
      padding: 8px;
      box-shadow: inset 0 0 0 6px rgba(15,23,42,.04);
    }

    /* Whack */
    .whack-grid{
      width: 100%;
      max-width: 560px;
      margin: 0 auto;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }
    .hole{
      position:relative;
      aspect-ratio: 1;
      border-radius: 22px;
      background:
        radial-gradient(90px 90px at 35% 35%, rgba(255,255,255,.9), rgba(255,255,255,.6) 55%, rgba(255,255,255,.35) 85%),
        linear-gradient(135deg, rgba(2,6,23,.08), rgba(2,6,23,.02));
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow-soft);
      overflow:hidden;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .mole{
      position:absolute;
      left: 50%;
      bottom: -30%;
      transform: translateX(-50%);
      width: 74%;
      aspect-ratio: 1;
      border-radius: 24px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 900;
      font-size: clamp(26px, 5vw, 44px);
      color: white;
      background: linear-gradient(135deg, var(--accent2), #8b5cf6);
      box-shadow: 0 18px 45px rgba(251,113,133,.25);
      transition: transform .12s ease, bottom .18s ease;
    }
    .mole.up{ bottom: 10%; }
    .mole.hit{ transform: translateX(-50%) scale(.92) rotate(-3deg); filter: brightness(.95); }

    /* Tracing */
    canvas{ touch-action: none; }

    /* Drawer */
    .drawer{
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      width: min(340px, 86vw);
      z-index: 60;
      transform: translateX(-110%);
      transition: transform .22s ease;
    }
    .drawer.open{ transform: translateX(0); }

    /* helpers */
    .safe{ padding-bottom: env(safe-area-inset-bottom); padding-top: env(safe-area-inset-top); }

    @media (prefers-reduced-motion: reduce){
      *{ animation: none !important; transition: none !important; }
    }
  </style>
</head>

<body>
  <div id="app" class="min-h-screen safe">
    <!-- Top bar -->
    <header class="sticky top-0 z-30 px-4 pt-[env(safe-area-inset-top)]">
      <div class="mx-auto max-w-[980px] glass rounded-2xl mt-3 px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <button class="btn btn-gray px-3" onclick="app.toggleDrawer()" aria-label="Open menu">
            <i class="fa-solid fa-bars"></i>
          </button>
          <div class="flex items-center gap-2">
            <div class="w-10 h-10 rounded-2xl bg-gradient-to-br from-sky-400 via-violet-400 to-rose-400 text-white grid place-items-center font-extrabold">A</div>
            <div>
              <div class="font-extrabold text-lg leading-tight">Athena</div>
              <div class="text-xs text-slate-500 -mt-0.5">Grow-with-me learning games</div>
            </div>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <div class="pill rounded-full px-3 py-2 flex items-center gap-2">
            <i class="fa-solid fa-fire text-orange-500"></i>
            <span class="font-extrabold" id="streak-count">0</span>
          </div>
          <div class="pill rounded-full px-3 py-2 flex items-center gap-2">
            <i class="fa-solid fa-star text-yellow-500"></i>
            <span class="font-extrabold" id="points-count">0</span>
          </div>
          <div class="pill rounded-full px-3 py-2 hidden sm:flex items-center gap-2">
            <i class="fa-solid fa-trophy text-sky-600"></i>
            <span class="font-extrabold" id="level-text">Level 1</span>
          </div>
        </div>
      </div>
    </header>

    <!-- Main -->
    <main id="main" class="px-4 pb-28">
      <div class="mx-auto max-w-[980px] py-4" id="main-content"></div>
    </main>

    <!-- Tab bar -->
    <div class="tabbar">
      <div class="tabbar-inner">
        <button class="tab active" data-tab="home" onclick="app.switchTab('home', event)" aria-label="Home">
          <i class="fa-solid fa-house text-lg"></i>
          <span class="text-xs font-bold">Home</span>
        </button>
        <button class="tab" data-tab="games" onclick="app.switchTab('games', event)" aria-label="Games">
          <i class="fa-solid fa-gamepad text-lg"></i>
          <span class="text-xs font-bold">Games</span>
        </button>
        <button class="tab" data-tab="progress" onclick="app.switchTab('progress', event)" aria-label="Progress">
          <i class="fa-solid fa-chart-line text-lg"></i>
          <span class="text-xs font-bold">Progress</span>
        </button>
        <button class="tab" data-tab="profile" onclick="app.switchTab('profile', event)" aria-label="Profile">
          <i class="fa-solid fa-user text-lg"></i>
          <span class="text-xs font-bold">Profile</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Drawer -->
  <div id="drawer-overlay" class="fixed inset-0 z-50 bg-black/40 opacity-0 pointer-events-none transition" onclick="app.toggleDrawer()"></div>
  <aside id="drawer" class="drawer glass">
    <div class="p-5">
      <div class="flex items-center justify-between">
        <div class="font-extrabold text-xl">Menu</div>
        <button class="btn btn-gray px-3" onclick="app.toggleDrawer()" aria-label="Close menu"><i class="fa-solid fa-xmark"></i></button>
      </div>

      <div class="mt-4 p-4 rounded-2xl bg-gradient-to-br from-sky-50 via-rose-50 to-amber-50 border border-black/5">
        <div class="flex items-center gap-3">
          <div class="w-14 h-14 rounded-2xl bg-white/80 border border-black/5 grid place-items-center text-3xl" id="user-avatar">üë¶</div>
          <div>
            <div class="font-extrabold" id="user-name">Explorer</div>
            <div class="text-xs text-slate-600" id="user-age">Age Group: Seedling</div>
          </div>
        </div>
      </div>

      <div class="mt-4 grid gap-2">
        <button class="btn btn-gray text-left" onclick="app.openAgeSelector()"><i class="fa-solid fa-users mr-2 text-sky-600"></i>Change age group</button>
        <button class="btn btn-gray text-left" onclick="app.openHelp('app')"><i class="fa-solid fa-circle-question mr-2 text-rose-500"></i>How Athena works</button>
        <button class="btn btn-gray text-left" onclick="app.resetAll()"><i class="fa-solid fa-rotate-left mr-2 text-slate-600"></i>Reset demo data</button>
      </div>

      <div class="mt-5 p-4 rounded-2xl bg-white/70 border border-black/5">
        <div class="font-extrabold">Daily Challenge</div>
        <div class="text-sm text-slate-600 mt-1">Play 3 mini-games today</div>
        <div class="mt-3 h-2 rounded-full bg-slate-200 overflow-hidden">
          <div id="challenge-bar" class="h-2 rounded-full bg-gradient-to-r from-sky-400 to-rose-400" style="width: 0%"></div>
        </div>
        <div class="mt-2 text-xs text-slate-600"><span id="challenge-text">0/3</span> complete</div>
      </div>

      <div class="mt-5 text-xs text-slate-500">
        Tip: Enable <b>Voice Coach</b> in Profile for spoken game instructions.
      </div>
    </div>
  </aside>

  <!-- Templates -->
  <template id="home-template">
    <div class="grid gap-4">
      <section class="glass rounded-3xl p-5">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-sm text-slate-600">Welcome back</div>
            <div class="text-3xl font-extrabold tracking-tight">Hi, <span id="welcome-name">Explorer</span>!</div>
            <div class="text-slate-600 mt-1">Pick a game. Athena will mix skills (math + memory + language) so your brain gets stronger.</div>
          </div>
          <div class="hidden sm:block">
            <div class="w-20 h-20 rounded-3xl bg-gradient-to-br from-sky-400 via-violet-400 to-rose-400 grid place-items-center text-white shadow-lg">
              <i class="fa-solid fa-wand-magic-sparkles text-3xl"></i>
            </div>
          </div>
        </div>

        <div class="mt-4 flex flex-wrap items-center gap-2">
          <button class="btn btn-primary" onclick="app.quickStart()"><i class="fa-solid fa-bolt mr-2"></i>Quick Start Mix</button>
          <button class="btn btn-gray" onclick="app.openHelp('home')"><i class="fa-solid fa-circle-question mr-2"></i>How to play</button>
        </div>
      </section>

      <section class="grid md:grid-cols-2 gap-4">
        <div class="glass rounded-3xl p-5">
          <div class="flex items-center justify-between">
            <div>
              <div class="font-extrabold text-xl">Today‚Äôs Challenge</div>
              <div class="text-sm text-slate-600">Complete 3 games to keep your streak alive.</div>
            </div>
            <button class="btn btn-pink" onclick="app.switchTab('games')">Play</button>
          </div>
          <div class="mt-3 h-3 rounded-full bg-slate-200 overflow-hidden">
            <div id="home-challenge-bar" class="h-3 rounded-full bg-gradient-to-r from-rose-400 to-amber-400" style="width: 0%"></div>
          </div>
          <div class="mt-2 text-xs text-slate-600"><span id="home-challenge-text">0/3</span> done</div>
        </div>

        <div class="glass rounded-3xl p-5">
          <div class="font-extrabold text-xl">Coach Mode</div>
          <div class="text-sm text-slate-600 mt-1">Turn on <b>Voice Coach</b> and Athena will explain each game step-by-step.</div>
          <div class="mt-3 flex items-center justify-between pill rounded-2xl px-4 py-3">
            <div class="flex items-center gap-2">
              <i class="fa-solid fa-volume-high text-sky-600"></i>
              <div>
                <div class="font-extrabold">Voice Coach</div>
                <div class="text-xs text-slate-600">Uses your device text-to-speech</div>
              </div>
            </div>
            <button class="btn btn-gray" onclick="app.togglePref('voiceCoach')" id="voiceCoachToggle">Off</button>
          </div>
        </div>
      </section>

      <section>
        <div class="flex items-center justify-between">
          <div class="font-extrabold text-xl">Quick Games</div>
          <button class="btn btn-gray" onclick="app.switchTab('games')">See all</button>
        </div>
        <div class="mt-3 grid grid-cols-2 md:grid-cols-4 gap-3">
          <button class="glass rounded-3xl p-4 text-left hover:shadow-xl transition" onclick="app.startGame('tea')">
            <div class="text-3xl">ü´ñ</div>
            <div class="font-extrabold mt-2">Tea Party</div>
            <div class="text-xs text-slate-600">Counting + colors</div>
          </button>
          <button class="glass rounded-3xl p-4 text-left hover:shadow-xl transition" onclick="app.startGame('whack')">
            <div class="text-3xl">üî®</div>
            <div class="font-extrabold mt-2">Whack!</div>
            <div class="text-xs text-slate-600">Fast focus game</div>
          </button>
          <button class="glass rounded-3xl p-4 text-left hover:shadow-xl transition" onclick="app.startGame('tracing')">
            <div class="text-3xl">‚úèÔ∏è</div>
            <div class="font-extrabold mt-2">Tracing</div>
            <div class="text-xs text-slate-600">Letters & numbers</div>
          </button>
          <button class="glass rounded-3xl p-4 text-left hover:shadow-xl transition" onclick="app.startGame('math')">
            <div class="text-3xl">üßÆ</div>
            <div class="font-extrabold mt-2">Math</div>
            <div class="text-xs text-slate-600">Adaptive problems</div>
          </button>
        </div>
      </section>
    </div>
  </template>

  <template id="games-template">
    <div class="grid gap-4">
      <div class="glass rounded-3xl p-5">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-2xl font-extrabold">Games</div>
            <div class="text-slate-600">These are stable, touch-friendly games (no glitchy drag-and-drop).</div>
          </div>
          <button class="btn btn-gray" onclick="app.openHelp('games')"><i class="fa-solid fa-circle-question mr-2"></i>Help</button>
        </div>
      </div>

      <div class="grid md:grid-cols-2 gap-4">
        <div class="glass rounded-3xl p-5">
          <div class="flex items-center justify-between">
            <div>
              <div class="font-extrabold text-xl">Tea Party Table</div>
              <div class="text-sm text-slate-600">Serve the correct number & color.</div>
            </div>
            <button class="btn btn-primary" onclick="app.startGame('tea')">Play</button>
          </div>
          <div class="mt-3 text-sm text-slate-600">Skills: counting, colors, following directions.</div>
        </div>

        <div class="glass rounded-3xl p-5">
          <div class="flex items-center justify-between">
            <div>
              <div class="font-extrabold text-xl">Whack-a-Target</div>
              <div class="text-sm text-slate-600">Whack the right letter/number before it disappears.</div>
            </div>
            <button class="btn btn-pink" onclick="app.startGame('whack')">Play</button>
          </div>
          <div class="mt-3 text-sm text-slate-600">Skills: focus, retrieval, reaction time.</div>
        </div>

        <div class="glass rounded-3xl p-5">
          <div class="flex items-center justify-between">
            <div>
              <div class="font-extrabold text-xl">Tracing Studio</div>
              <div class="text-sm text-slate-600">Trace letters/numbers with a guide.</div>
            </div>
            <button class="btn btn-green" onclick="app.startGame('tracing')">Play</button>
          </div>
          <div class="mt-3 text-sm text-slate-600">Skills: handwriting, fine motor.</div>
        </div>

        <div class="glass rounded-3xl p-5">
          <div class="flex items-center justify-between">
            <div>
              <div class="font-extrabold text-xl">Math Adventure</div>
              <div class="text-sm text-slate-600">Adaptive questions + hints.</div>
            </div>
            <button class="btn btn-primary" onclick="app.startGame('math')">Play</button>
          </div>
          <div class="mt-3 text-sm text-slate-600">Skills: number sense, mental math.</div>
        </div>

        <div class="glass rounded-3xl p-5">
          <div class="flex items-center justify-between">
            <div>
              <div class="font-extrabold text-xl">Memory Match</div>
              <div class="text-sm text-slate-600">Flip & match pairs.</div>
            </div>
            <button class="btn btn-pink" onclick="app.startGame('memory')">Play</button>
          </div>
          <div class="mt-3 text-sm text-slate-600">Skills: working memory, attention.</div>
        </div>

        <div class="glass rounded-3xl p-5">
          <div class="flex items-center justify-between">
            <div>
              <div class="font-extrabold text-xl">Potty Routine</div>
              <div class="text-sm text-slate-600">Practice steps: go ‚Üí wipe ‚Üí flush ‚Üí wash.</div>
            </div>
            <button class="btn btn-green" onclick="app.startGame('potty')">Play</button>
          </div>
          <div class="mt-3 text-sm text-slate-600">Skills: routines, independence.</div>
        </div>
      </div>
    </div>
  </template>

  <template id="progress-template">
    <div class="grid gap-4">
      <div class="glass rounded-3xl p-5">
        <div class="text-2xl font-extrabold">Progress</div>
        <div class="text-slate-600">Points are for motivation. The real goal is steady practice.</div>
      </div>

      <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <div class="glass rounded-3xl p-4 text-center">
          <div class="text-3xl font-extrabold" id="stat-total">0</div>
          <div class="text-xs text-slate-600">Total points</div>
        </div>
        <div class="glass rounded-3xl p-4 text-center">
          <div class="text-3xl font-extrabold" id="stat-streak">0</div>
          <div class="text-xs text-slate-600">Day streak</div>
        </div>
        <div class="glass rounded-3xl p-4 text-center">
          <div class="text-3xl font-extrabold" id="stat-played">0</div>
          <div class="text-xs text-slate-600">Games played</div>
        </div>
        <div class="glass rounded-3xl p-4 text-center">
          <div class="text-3xl font-extrabold" id="stat-rank">Beginner</div>
          <div class="text-xs text-slate-600">Rank</div>
        </div>
      </div>

      <div class="glass rounded-3xl p-5">
        <div class="flex items-center justify-between">
          <div>
            <div class="font-extrabold text-xl">Spaced Review Queue (Demo)</div>
            <div class="text-sm text-slate-600">Athena re-checks skills after 1 day, 3 days, 1 week‚Ä¶</div>
          </div>
          <button class="btn btn-gray" onclick="app.seedReviews()">Generate sample</button>
        </div>
        <div class="mt-4 grid gap-2" id="review-list"></div>
      </div>

      <div class="glass rounded-3xl p-5">
        <div class="font-extrabold text-xl">Recent Activity</div>
        <div class="mt-3 grid gap-2" id="activity-list"></div>
      </div>
    </div>
  </template>

  <template id="profile-template">
    <div class="grid gap-4">
      <div class="glass rounded-3xl p-5">
        <div class="flex items-center gap-4">
          <div class="w-20 h-20 rounded-3xl bg-gradient-to-br from-sky-400 via-violet-400 to-rose-400 grid place-items-center text-white text-4xl" id="profile-avatar">üë¶</div>
          <div class="flex-1">
            <div class="text-2xl font-extrabold" id="profile-name">Explorer</div>
            <div class="text-slate-600">Level <span id="profile-level">1</span> ‚Ä¢ <span id="profile-rank">Beginner</span></div>
          </div>
          <button class="btn btn-gray" onclick="app.openHelp('profile')"><i class="fa-solid fa-circle-question mr-2"></i>Help</button>
        </div>
      </div>

      <div class="glass rounded-3xl p-5">
        <div class="font-extrabold text-xl">Avatar</div>
        <div class="mt-3 grid grid-cols-4 sm:grid-cols-8 gap-2">
          <button class="btn btn-gray" onclick="app.setAvatar('üë¶')">üë¶</button>
          <button class="btn btn-gray" onclick="app.setAvatar('üëß')">üëß</button>
          <button class="btn btn-gray" onclick="app.setAvatar('üßí')">üßí</button>
          <button class="btn btn-gray" onclick="app.setAvatar('üë∂')">üë∂</button>
          <button class="btn btn-gray" onclick="app.setAvatar('ü¶∏')">ü¶∏</button>
          <button class="btn btn-gray" onclick="app.setAvatar('üë©‚ÄçüöÄ')">üë©‚ÄçüöÄ</button>
          <button class="btn btn-gray" onclick="app.setAvatar('üßô')">üßô</button>
          <button class="btn btn-gray" onclick="app.setAvatar('ü§ñ')">ü§ñ</button>
        </div>
      </div>

      <div class="glass rounded-3xl p-5">
        <div class="font-extrabold text-xl">Preferences</div>
        <div class="mt-3 grid gap-2">
          <div class="pill rounded-2xl px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-2"><i class="fa-solid fa-volume-high text-sky-600"></i><div><div class="font-extrabold">Sound Effects</div><div class="text-xs text-slate-600">Clicks, success, gentle buzz</div></div></div>
            <button class="btn btn-gray" onclick="app.togglePref('sound')" id="soundToggle">On</button>
          </div>
          <div class="pill rounded-2xl px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-2"><i class="fa-solid fa-comment-dots text-rose-500"></i><div><div class="font-extrabold">Voice Coach</div><div class="text-xs text-slate-600">Spoken instructions & hints</div></div></div>
            <button class="btn btn-gray" onclick="app.togglePref('voiceCoach')" id="voiceCoachToggle2">Off</button>
          </div>
          <div class="pill rounded-2xl px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-2"><i class="fa-solid fa-mobile-screen text-emerald-600"></i><div><div class="font-extrabold">Vibration</div><div class="text-xs text-slate-600">Tiny haptics on success</div></div></div>
            <button class="btn btn-gray" onclick="app.togglePref('haptics')" id="hapticsToggle">On</button>
          </div>
        </div>
      </div>

      <div class="glass rounded-3xl p-5">
        <div class="font-extrabold text-xl">Age Group UI</div>
        <div class="text-sm text-slate-600 mt-1">Seedlings get bigger buttons and simpler prompts.</div>
        <div class="mt-3 grid grid-cols-3 gap-2">
          <button class="btn btn-gray" onclick="app.setAge('seedling')">2‚Äì6</button>
          <button class="btn btn-gray" onclick="app.setAge('explorer')">7‚Äì11</button>
          <button class="btn btn-gray" onclick="app.setAge('master')">12‚Äì17</button>
        </div>
      </div>
    </div>
  </template>

  <!-- GAME: Memory -->
  <template id="game-memory">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-overlay" onclick="app.closeGame()"></div>
      <div class="sheet glass">
        <div class="sheet-header">
          <div class="flex items-center gap-2">
            <div class="font-extrabold text-lg">Memory Match</div>
            <span class="text-xs text-slate-600">Find all pairs</span>
          </div>
          <div class="flex items-center gap-2">
            <button class="btn btn-gray" onclick="app.openHelp('memory')"><i class="fa-solid fa-circle-question"></i></button>
            <button class="btn btn-gray" onclick="app.closeGame()"><i class="fa-solid fa-xmark"></i></button>
          </div>
        </div>
        <div class="sheet-body">
          <div class="grid grid-cols-3 sm:grid-cols-6 gap-3 text-center">
            <div class="pill rounded-2xl py-2"><div class="text-xs text-slate-600">Moves</div><div class="text-xl font-extrabold" id="mm-moves">0</div></div>
            <div class="pill rounded-2xl py-2"><div class="text-xs text-slate-600">Matches</div><div class="text-xl font-extrabold" id="mm-matches">0</div></div>
            <div class="pill rounded-2xl py-2"><div class="text-xs text-slate-600">Time</div><div class="text-xl font-extrabold" id="mm-time">00:00</div></div>
            <div class="pill rounded-2xl py-2 sm:col-span-3 flex items-center justify-center gap-2">
              <button class="btn btn-primary" onclick="app.mmNew()"><i class="fa-solid fa-rotate-right mr-2"></i>New</button>
              <button class="btn btn-pink" onclick="app.mmHint()"><i class="fa-solid fa-lightbulb mr-2"></i>Hint</button>
            </div>
          </div>

          <div class="mt-4 grid grid-cols-4 sm:grid-cols-6 gap-3" id="mm-grid"></div>
        </div>
      </div>
    </div>
  </template>

  <!-- GAME: Tracing -->
  <template id="game-tracing">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-overlay" onclick="app.closeGame()"></div>
      <div class="sheet glass">
        <div class="sheet-header">
          <div class="flex items-center gap-2">
            <div class="font-extrabold text-lg">Tracing Studio</div>
            <span class="text-xs text-slate-600">Trace the guide</span>
          </div>
          <div class="flex items-center gap-2">
            <button class="btn btn-gray" onclick="app.openHelp('tracing')"><i class="fa-solid fa-circle-question"></i></button>
            <button class="btn btn-gray" onclick="app.closeGame()"><i class="fa-solid fa-xmark"></i></button>
          </div>
        </div>
        <div class="sheet-body">
          <div class="grid sm:grid-cols-2 gap-4">
            <div>
              <div class="pill rounded-2xl p-3">
                <div class="text-sm font-extrabold">Mode</div>
                <div class="mt-2 grid grid-cols-3 gap-2">
                  <button class="btn btn-gray" onclick="app.trSetMode('letters')" id="tr-btn-letters">Letters</button>
                  <button class="btn btn-gray" onclick="app.trSetMode('numbers')" id="tr-btn-numbers">Numbers</button>
                  <button class="btn btn-gray" onclick="app.trSetMode('shapes')" id="tr-btn-shapes">Shapes</button>
                </div>
                <div class="mt-3 text-sm text-slate-600">Goal: follow the dotted guide. Tap <b>Check</b> when done.</div>
              </div>

              <div class="mt-3 grid grid-cols-3 gap-2">
                <button class="btn btn-gray" onclick="app.trClear()"><i class="fa-solid fa-eraser mr-2"></i>Clear</button>
                <button class="btn btn-primary" onclick="app.trNext()"><i class="fa-solid fa-forward-step mr-2"></i>Next</button>
                <button class="btn btn-green" onclick="app.trCheck()"><i class="fa-solid fa-check mr-2"></i>Check</button>
              </div>

              <div class="mt-3 pill rounded-2xl p-3">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="text-xs text-slate-600">Now tracing</div>
                    <div class="text-2xl font-extrabold" id="tr-char">A</div>
                  </div>
                  <div class="text-right">
                    <div class="text-xs text-slate-600">Progress</div>
                    <div class="text-2xl font-extrabold" id="tr-score">0</div>
                  </div>
                </div>
              </div>
            </div>

            <div>
              <div class="glass rounded-3xl p-3">
                <div class="relative rounded-2xl overflow-hidden border border-black/5 bg-white">
                  <canvas id="tr-canvas" class="w-full" style="height: 340px;"></canvas>
                </div>
                <div class="mt-2 text-xs text-slate-600">Tip: use one finger. This canvas is optimized for mobile (Pointer Events).</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </template>

  <!-- GAME: Math -->
  <template id="game-math">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-overlay" onclick="app.closeGame()"></div>
      <div class="sheet glass">
        <div class="sheet-header">
          <div class="flex items-center gap-2">
            <div class="font-extrabold text-lg">Math Adventure</div>
            <span class="text-xs text-slate-600">Adaptive + hints</span>
          </div>
          <div class="flex items-center gap-2">
            <button class="btn btn-gray" onclick="app.openHelp('math')"><i class="fa-solid fa-circle-question"></i></button>
            <button class="btn btn-gray" onclick="app.closeGame()"><i class="fa-solid fa-xmark"></i></button>
          </div>
        </div>
        <div class="sheet-body">
          <div class="grid grid-cols-3 gap-2">
            <div class="pill rounded-2xl p-3 text-center"><div class="text-xs text-slate-600">Score</div><div class="text-2xl font-extrabold" id="m-score">0</div></div>
            <div class="pill rounded-2xl p-3 text-center"><div class="text-xs text-slate-600">Level</div><div class="text-2xl font-extrabold" id="m-level">1</div></div>
            <div class="pill rounded-2xl p-3 text-center"><div class="text-xs text-slate-600">Streak</div><div class="text-2xl font-extrabold" id="m-streak">0</div></div>
          </div>

          <div class="mt-4 glass rounded-3xl p-5">
            <div class="text-4xl font-extrabold text-center" id="m-problem">5 + 3 = ?</div>
            <div class="mt-4 grid grid-cols-2 gap-2" id="m-options"></div>
            <div class="mt-3 text-center font-extrabold" id="m-feedback"></div>
            <div class="mt-3 flex gap-2">
              <button class="btn btn-gray flex-1" onclick="app.mSkip()"><i class="fa-solid fa-forward mr-2"></i>Skip</button>
              <button class="btn btn-pink flex-1" onclick="app.mHint()"><i class="fa-solid fa-lightbulb mr-2"></i>Hint</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </template>

  <!-- GAME: Tea Party -->
  <template id="game-tea">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-overlay" onclick="app.closeGame()"></div>
      <div class="sheet glass">
        <div class="sheet-header">
          <div class="flex items-center gap-2">
            <div class="font-extrabold text-lg">Tea Party Table</div>
            <span class="text-xs text-slate-600">Serve guests correctly</span>
          </div>
          <div class="flex items-center gap-2">
            <button class="btn btn-gray" onclick="app.openHelp('tea')"><i class="fa-solid fa-circle-question"></i></button>
            <button class="btn btn-gray" onclick="app.closeGame()"><i class="fa-solid fa-xmark"></i></button>
          </div>
        </div>
        <div class="sheet-body">
          <div class="grid gap-4">
            <div class="pill rounded-3xl p-4">
              <div class="text-xs text-slate-600">Your task</div>
              <div class="text-xl font-extrabold" id="tea-instruction">Serve the Robot 2 blue cookies.</div>
              <div class="text-sm text-slate-600 mt-1">Tap a guest, then tap treats to place them on their plate.</div>
            </div>

            <div class="table-wrap">
              <div class="table-oval"></div>

              <div class="guest" style="left: 6%; top: 36%;" data-guest="bear">
                <div class="avatar" id="g-bear" onclick="app.teaSelect('bear')" role="button" aria-label="Select Bear">üß∏</div>
                <div class="plate" id="plate-bear" aria-label="Bear plate"></div>
                <div class="text-xs font-extrabold">Bear</div>
              </div>

              <div class="guest" style="left: 34%; top: 3%;" data-guest="robot">
                <div class="avatar" id="g-robot" onclick="app.teaSelect('robot')" role="button" aria-label="Select Robot">ü§ñ</div>
                <div class="plate" id="plate-robot" aria-label="Robot plate"></div>
                <div class="text-xs font-extrabold">Robot</div>
              </div>

              <div class="guest" style="right: 6%; top: 36%;" data-guest="doll">
                <div class="avatar" id="g-doll" onclick="app.teaSelect('doll')" role="button" aria-label="Select Doll">ü™Ü</div>
                <div class="plate" id="plate-doll" aria-label="Doll plate"></div>
                <div class="text-xs font-extrabold">Doll</div>
              </div>
            </div>

            <div class="grid sm:grid-cols-2 gap-3">
              <div class="glass rounded-3xl p-4">
                <div class="font-extrabold">Treats</div>
                <div class="text-sm text-slate-600">Add to the selected guest‚Äôs plate:</div>
                <div class="mt-3 flex flex-wrap gap-2">
                  <button class="btn btn-primary" onclick="app.teaAdd('cookie','blue')">üç™ Blue</button>
                  <button class="btn btn-pink" onclick="app.teaAdd('cookie','red')">üç™ Red</button>
                  <button class="btn btn-green" onclick="app.teaAdd('cookie','green')">üç™ Green</button>
                </div>
                <div class="mt-3 flex gap-2">
                  <button class="btn btn-gray flex-1" onclick="app.teaClearSelected()"><i class="fa-solid fa-eraser mr-2"></i>Clear plate</button>
                  <button class="btn btn-primary flex-1" onclick="app.teaNext()"><i class="fa-solid fa-forward-step mr-2"></i>Next task</button>
                </div>
              </div>

              <div class="glass rounded-3xl p-4">
                <div class="font-extrabold">Status</div>
                <div class="mt-2 grid gap-2 text-sm">
                  <div class="pill rounded-2xl px-4 py-3 flex items-center justify-between"><span>Selected guest</span><span class="font-extrabold" id="tea-selected">Robot</span></div>
                  <div class="pill rounded-2xl px-4 py-3 flex items-center justify-between"><span>Rounds</span><span class="font-extrabold" id="tea-round">1</span></div>
                  <div class="pill rounded-2xl px-4 py-3 flex items-center justify-between"><span>Score</span><span class="font-extrabold" id="tea-score">0</span></div>
                </div>
                <div class="mt-3 text-xs text-slate-600">Metacognition: after each round, Athena tells you what strategy worked.</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </template>

  <!-- GAME: Whack -->
  <template id="game-whack">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-overlay" onclick="app.closeGame()"></div>
      <div class="sheet glass">
        <div class="sheet-header">
          <div class="flex items-center gap-2">
            <div class="font-extrabold text-lg">Whack-a-Target</div>
            <span class="text-xs text-slate-600">Fast focus</span>
          </div>
          <div class="flex items-center gap-2">
            <button class="btn btn-gray" onclick="app.openHelp('whack')"><i class="fa-solid fa-circle-question"></i></button>
            <button class="btn btn-gray" onclick="app.closeGame()"><i class="fa-solid fa-xmark"></i></button>
          </div>
        </div>
        <div class="sheet-body">
          <div class="grid gap-4">
            <div class="pill rounded-3xl p-4">
              <div class="text-xs text-slate-600">Instruction</div>
              <div class="text-xl font-extrabold" id="wh-instruction">Press Start to begin.</div>
              <div class="text-sm text-slate-600 mt-1">Tap the correct target. Wrong taps are okay‚ÄîAthena will coach you.</div>
            </div>

            <div class="grid grid-cols-3 gap-2">
              <div class="pill rounded-2xl p-3 text-center"><div class="text-xs text-slate-600">Time</div><div class="text-2xl font-extrabold" id="wh-time">30</div></div>
              <div class="pill rounded-2xl p-3 text-center"><div class="text-xs text-slate-600">Score</div><div class="text-2xl font-extrabold" id="wh-score">0</div></div>
              <div class="pill rounded-2xl p-3 text-center"><div class="text-xs text-slate-600">Streak</div><div class="text-2xl font-extrabold" id="wh-streak">0</div></div>
            </div>

            <div class="whack-grid" id="wh-grid"></div>

            <div class="grid sm:grid-cols-3 gap-2">
              <button class="btn btn-primary" onclick="app.whStart()"><i class="fa-solid fa-play mr-2"></i>Start</button>
              <button class="btn btn-gray" onclick="app.whStop()"><i class="fa-solid fa-pause mr-2"></i>Pause</button>
              <button class="btn btn-pink" onclick="app.whExplain()"><i class="fa-solid fa-headset mr-2"></i>Explain</button>
            </div>

            <div class="text-xs text-slate-600">Tip: If Voice Coach is on, ‚ÄúExplain‚Äù will speak instructions out loud.</div>
          </div>
        </div>
      </div>
    </div>
  </template>

  <!-- GAME: Potty -->
  <template id="game-potty">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-overlay" onclick="app.closeGame()"></div>
      <div class="sheet glass">
        <div class="sheet-header">
          <div class="flex items-center gap-2">
            <div class="font-extrabold text-lg">Potty Routine</div>
            <span class="text-xs text-slate-600">Practice the steps</span>
          </div>
          <div class="flex items-center gap-2">
            <button class="btn btn-gray" onclick="app.openHelp('potty')"><i class="fa-solid fa-circle-question"></i></button>
            <button class="btn btn-gray" onclick="app.closeGame()"><i class="fa-solid fa-xmark"></i></button>
          </div>
        </div>
        <div class="sheet-body">
          <div class="grid gap-4">
            <div class="pill rounded-3xl p-4">
              <div class="text-xs text-slate-600">Step</div>
              <div class="text-xl font-extrabold" id="pt-step">1) Go potty</div>
              <div class="text-sm text-slate-600 mt-1" id="pt-coach">Tap the big button to practice the step.</div>
            </div>

            <div class="glass rounded-3xl p-4">
              <!-- Simple inline "imagery" with SVG + animation hooks -->
              <div class="grid md:grid-cols-2 gap-4 items-center">
                <div class="rounded-3xl bg-gradient-to-br from-sky-50 via-rose-50 to-amber-50 border border-black/5 p-4">
                  <svg viewBox="0 0 420 280" class="w-full h-auto" aria-label="Bathroom scene illustration" role="img">
                    <defs>
                      <linearGradient id="wall" x1="0" x2="1">
                        <stop offset="0" stop-color="#e0f2fe" />
                        <stop offset="1" stop-color="#ffe4e6" />
                      </linearGradient>
                      <linearGradient id="toilet" x1="0" x2="1">
                        <stop offset="0" stop-color="#ffffff" />
                        <stop offset="1" stop-color="#e2e8f0" />
                      </linearGradient>
                      <linearGradient id="water" x1="0" x2="0" y1="0" y2="1">
                        <stop offset="0" stop-color="#60a5fa" stop-opacity=".9" />
                        <stop offset="1" stop-color="#22d3ee" stop-opacity=".65" />
                      </linearGradient>
                    </defs>

                    <!-- wall -->
                    <rect x="0" y="0" width="420" height="280" rx="26" fill="url(#wall)" />
                    <!-- floor -->
                    <rect x="0" y="200" width="420" height="80" fill="#fde68a" opacity=".35" />

                    <!-- toilet -->
                    <g transform="translate(40,70)">
                      <rect x="0" y="0" width="140" height="70" rx="18" fill="url(#toilet)" stroke="#0f172a" stroke-opacity=".08" />
                      <rect x="24" y="56" width="92" height="94" rx="20" fill="url(#toilet)" stroke="#0f172a" stroke-opacity=".08" />
                      <ellipse cx="70" cy="108" rx="44" ry="20" fill="#93c5fd" opacity=".45" />
                      <ellipse cx="70" cy="108" rx="34" ry="14" fill="#60a5fa" opacity=".25" id="pt-water" />
                      <circle cx="120" cy="30" r="8" fill="#94a3b8" />
                    </g>

                    <!-- sink -->
                    <g transform="translate(240,60)">
                      <rect x="20" y="0" width="120" height="40" rx="14" fill="#ffffff" opacity=".8" />
                      <rect x="0" y="40" width="160" height="92" rx="22" fill="#ffffff" stroke="#0f172a" stroke-opacity=".08" />
                      <rect x="56" y="132" width="48" height="68" rx="16" fill="#e2e8f0" />
                      <path d="M70 28 C70 10, 90 10, 90 28" fill="none" stroke="#64748b" stroke-width="10" stroke-linecap="round" />
                      <rect x="72" y="38" width="16" height="0" rx="8" fill="url(#water)" id="pt-stream" />
                    </g>

                    <!-- soap bubbles -->
                    <g id="pt-bubbles" opacity="0">
                      <circle cx="330" cy="185" r="10" fill="#fff" opacity=".8" />
                      <circle cx="360" cy="200" r="14" fill="#fff" opacity=".65" />
                      <circle cx="310" cy="210" r="8" fill="#fff" opacity=".75" />
                      <circle cx="350" cy="225" r="9" fill="#fff" opacity=".7" />
                    </g>

                    <!-- character -->
                    <g transform="translate(190,150)">
                      <rect x="0" y="0" width="60" height="80" rx="20" fill="#ffffff" opacity=".65" />
                      <text x="30" y="48" text-anchor="middle" font-size="30">üôÇ</text>
                    </g>
                  </svg>
                </div>

                <div class="grid gap-2">
                  <button class="btn btn-primary" onclick="app.ptDoStep()"><i class="fa-solid fa-hand-sparkles mr-2"></i>Do step</button>
                  <button class="btn btn-green" onclick="app.ptNext()"><i class="fa-solid fa-forward-step mr-2"></i>Next</button>
                  <button class="btn btn-gray" onclick="app.ptExplain()"><i class="fa-solid fa-headset mr-2"></i>Explain</button>
                  <div class="pill rounded-2xl px-4 py-3 text-sm text-slate-600">Hand-wash step includes a 20-second timer (with bubbles). Great for routine building.</div>
                </div>
              </div>
            </div>

            <div class="grid grid-cols-2 sm:grid-cols-4 gap-2">
              <div class="pill rounded-2xl p-3 text-center"><div class="text-xs text-slate-600">Step</div><div class="text-2xl font-extrabold" id="pt-stepnum">1</div></div>
              <div class="pill rounded-2xl p-3 text-center"><div class="text-xs text-slate-600">Stars</div><div class="text-2xl font-extrabold" id="pt-stars">0</div></div>
              <div class="pill rounded-2xl p-3 text-center"><div class="text-xs text-slate-600">Routine streak</div><div class="text-2xl font-extrabold" id="pt-streak">0</div></div>
              <div class="pill rounded-2xl p-3 text-center"><div class="text-xs text-slate-600">Today</div><div class="text-2xl font-extrabold" id="pt-today">0</div></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </template>

  <!-- Help / Coach Modal -->
  <template id="help-template">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-overlay" onclick="app.closeHelp()"></div>
      <div class="sheet glass">
        <div class="sheet-header">
          <div class="font-extrabold text-lg"><i class="fa-solid fa-circle-question mr-2 text-sky-600"></i>Athena Coach</div>
          <div class="flex items-center gap-2">
            <button class="btn btn-gray" onclick="app.speak(app.helpText || '')" title="Read aloud"><i class="fa-solid fa-volume-high"></i></button>
            <button class="btn btn-gray" onclick="app.closeHelp()"><i class="fa-solid fa-xmark"></i></button>
          </div>
        </div>
        <div class="sheet-body">
          <div class="text-lg font-extrabold" id="help-title">Help</div>
          <div class="mt-2 text-slate-700 leading-relaxed whitespace-pre-line" id="help-body"></div>
          <div class="mt-4 flex gap-2">
            <button class="btn btn-primary" onclick="app.closeHelp()">Got it</button>
            <button class="btn btn-gray" onclick="app.togglePref('voiceCoach')">Toggle Voice Coach</button>
          </div>
        </div>
      </div>
    </div>
  </template>

  <script>
    const app = {
      state: {
        tab: 'home',
        age: 'seedling',
        prefs: {
          sound: true,
          voiceCoach: false,
          haptics: true,
        },
        user: {
          name: 'Explorer',
          avatar: 'üë¶',
          level: 1,
          points: 0,
          streak: 0,
          totalPoints: 0,
          gamesPlayed: 0,
        },
        daily: {
          done: 0,
          goal: 3,
          lastDay: null,
        },
        activity: [],
        reviews: []
      },

      // runtime
      activeModalEl: null,
      activeHelpEl: null,
      timers: new Set(),
      rafs: new Set(),
      _audioCtx: null,

      // --- init ---
      init(){
        this.load();
        this.ensureDailyReset();
        this.render();
        this.updateTopUI();
        this.bindGlobal();
        this.updateChallengeUI();
      },

      bindGlobal(){
        document.addEventListener('keydown', (e)=>{
          if(e.key === 'Escape'){
            if(this.activeHelpEl) this.closeHelp();
            else if(this.activeModalEl) this.closeGame();
          }
        });

        // prevent iOS double tap zoom
        let lastTouchEnd = 0;
        document.addEventListener('touchend', (e)=>{
          const now = Date.now();
          if(now - lastTouchEnd <= 300) e.preventDefault();
          lastTouchEnd = now;
        }, {passive:false});
      },

      // --- persistence ---
      load(){
        const saved = localStorage.getItem('athena-state-v2');
        if(saved){
          try{
            const parsed = JSON.parse(saved);
            this.state = {
              ...this.state,
              ...parsed,
              prefs: { ...this.state.prefs, ...(parsed.prefs||{}) },
              user: { ...this.state.user, ...(parsed.user||{}) },
              daily: { ...this.state.daily, ...(parsed.daily||{}) },
            };
          }catch(err){
            console.warn('Bad saved state', err);
          }
        }
      },

      save(){
        localStorage.setItem('athena-state-v2', JSON.stringify(this.state));
      },

      resetAll(){
        localStorage.removeItem('athena-state-v2');
        localStorage.removeItem('athena-last-visit');
        location.reload();
      },

      // --- UI ---
      render(){
        const main = document.getElementById('main-content');
        const map = { home:'home-template', games:'games-template', progress:'progress-template', profile:'profile-template' };
        const t = document.getElementById(map[this.state.tab] || 'home-template');
        main.innerHTML = '';
        main.appendChild(t.content.cloneNode(true));
        this.postRender();
      },

      postRender(){
        // user fields
        const set = (id, val) => { const el = document.getElementById(id); if(el) el.textContent = val; };
        set('welcome-name', this.state.user.name);
        set('user-name', this.state.user.name);
        set('profile-name', this.state.user.name);

        set('user-avatar', this.state.user.avatar);
        set('profile-avatar', this.state.user.avatar);

        set('profile-level', this.state.user.level);
        set('profile-rank', this.rank());

        // profile toggles
        this.syncPrefButtons();

        // progress
        set('stat-total', this.state.user.totalPoints);
        set('stat-streak', this.state.user.streak);
        set('stat-played', this.state.user.gamesPlayed);
        set('stat-rank', this.rank());

        this.renderActivity();
        this.renderReviews();

        // age label in drawer
        const ageLabel = this.state.age === 'seedling' ? 'Seedling (2‚Äì6)' : this.state.age === 'explorer' ? 'Explorer (7‚Äì11)' : 'Master (12‚Äì17)';
        set('user-age', `Age Group: ${ageLabel}`);

        this.updateChallengeUI();
      },

      updateTopUI(){
        document.getElementById('streak-count').textContent = this.state.user.streak;
        document.getElementById('points-count').textContent = this.state.user.points;
        document.getElementById('level-text').textContent = `Level ${this.state.user.level}`;
      },

      updateChallengeUI(){
        const pct = Math.min(100, Math.round((this.state.daily.done / this.state.daily.goal) * 100));
        const t1 = document.getElementById('challenge-text');
        const b1 = document.getElementById('challenge-bar');
        const t2 = document.getElementById('home-challenge-text');
        const b2 = document.getElementById('home-challenge-bar');
        if(t1) t1.textContent = `${this.state.daily.done}/${this.state.daily.goal}`;
        if(b1) b1.style.width = `${pct}%`;
        if(t2) t2.textContent = `${this.state.daily.done}/${this.state.daily.goal}`;
        if(b2) b2.style.width = `${pct}%`;
      },

      syncPrefButtons(){
        const setBtn = (id, onText, offText, isOn) => {
          const el = document.getElementById(id);
          if(!el) return;
          el.textContent = isOn ? onText : offText;
          el.classList.toggle('btn-primary', isOn);
        };
        setBtn('soundToggle', 'On', 'Off', this.state.prefs.sound);
        setBtn('voiceCoachToggle', 'On', 'Off', this.state.prefs.voiceCoach);
        setBtn('voiceCoachToggle2', 'On', 'Off', this.state.prefs.voiceCoach);
        setBtn('hapticsToggle', 'On', 'Off', this.state.prefs.haptics);
      },

      switchTab(tab, evt){
        this.state.tab = tab;
        this.save();

        // update tab highlight robustly (works even if evt missing)
        document.querySelectorAll('.tab').forEach(btn=>{
          btn.classList.toggle('active', btn.dataset.tab === tab);
        });

        this.render();
        this.sfx('tap');
      },

      toggleDrawer(){
        const d = document.getElementById('drawer');
        const o = document.getElementById('drawer-overlay');
        const isOpen = d.classList.toggle('open');
        o.classList.toggle('opacity-0', !isOpen);
        o.classList.toggle('opacity-100', isOpen);
        o.classList.toggle('pointer-events-none', !isOpen);
        this.sfx('tap');
      },

      openAgeSelector(){
        this.toggleDrawer();
        const msg = "Choose an age group.\n\nSeedling (2‚Äì6): bigger prompts + simpler rules.\nExplorer (7‚Äì11): balanced.\nMaster (12‚Äì17): faster pace + harder targets.";
        this.openHelp('age', 'Age Groups', msg);
      },

      // --- coach/help ---
      helpText: '',
      helpTitle: '',

      openHelp(topic, titleOverride, bodyOverride){
        const map = this.helpContent();
        const title = titleOverride || (map[topic]?.title || 'Help');
        const body = bodyOverride || (map[topic]?.body || '');
        this.helpTitle = title;
        this.helpText = body;

        if(this.activeHelpEl) this.closeHelp();
        const tpl = document.getElementById('help-template');
        const wrap = document.createElement('div');
        wrap.innerHTML = tpl.innerHTML;
        const node = wrap.firstElementChild;
        document.body.appendChild(node);
        this.activeHelpEl = node;

        // fill
        node.querySelector('#help-title').textContent = title;
        node.querySelector('#help-body').textContent = body;

        this.sfx('tap');
        if(this.state.prefs.voiceCoach){
          this.speak(`${title}. ${body}`);
        }
      },

      closeHelp(){
        if(this.activeHelpEl){
          this.activeHelpEl.remove();
          this.activeHelpEl = null;
          this.sfx('tap');
        }
      },

      helpContent(){
        return {
          app: {
            title: 'How Athena works',
            body:
`Athena is built around 3 ideas:\n\n1) Spaced Practice: we revisit skills after delays so they stick.\n2) Interleaving: we mix skills (math + memory + language) so learning is deeper.\n3) Productive effort: wrong answers are normal‚ÄîAthena gives hints right away.\n\nTip: turn on Voice Coach in Profile to hear instructions.`
          },
          home: {
            title: 'Home',
            body:
`Quick Start Mix launches a short, fun combo of games.\n\nWhy? Mixing games makes your brain switch gears and remember better.`
          },
          games: {
            title: 'Games',
            body:
`All games here are built to be stable on phones and tablets.\nNo glitchy dragging required.\n\nTry: Tea Party (counting + colors) and Whack (fast focus).`
          },
          memory: {
            title: 'Memory Match',
            body:
`Flip 2 cards. If they match, you keep them!\n\nHint: use the "Hint" button to briefly reveal cards (it‚Äôs a learning tool).\nStrategy: say the emoji out loud as you flip it.`
          },
          tracing: {
            title: 'Tracing Studio',
            body:
`Trace the dotted guide.\n\n1) Choose Letters / Numbers / Shapes\n2) Draw with one finger\n3) Tap Check\n\nIf you miss, Athena says what to try next.`
          },
          math: {
            title: 'Math Adventure',
            body:
`Pick the correct answer.\n\nHint button gives a teaching hint (not just the answer).\nLevel increases as you get streaks.`
          },
          tea: {
            title: 'Tea Party Table',
            body:
`1) Tap a guest (Bear / Robot / Doll)\n2) Tap treats to add to that guest‚Äôs plate\n3) Match the instruction exactly\n\nTip: count out loud. This helps memory!`
          },
          whack: {
            title: 'Whack-a-Target (with verbal help)',
            body:
`Goal: tap the correct target before it hides.\n\nHow it works:\n1) Press Start\n2) Athena tells you what to whack (a letter or a number)\n3) A target pops up in one hole\n4) Tap it FAST if it matches the instruction\n\nIf you tap the wrong one: no problem‚ÄîAthena will say what to look for next time.\n\nTip: keep your eyes on the instruction line at the top.`
          },
          potty: {
            title: 'Potty Routine',
            body:
`Practice the routine steps:\nGo ‚Üí Wipe ‚Üí Flush ‚Üí Wash hands (20 seconds).\n\nTap "Explain" for spoken coaching.\nThe goal is confidence and calm repetition.`
          },
          profile: {
            title: 'Profile',
            body:
`Turn on Voice Coach if you want spoken instructions.\nSound and vibration can be toggled for quiet play.`
          }
        };
      },

      speak(text){
        if(!text) return;
        try{
          if(!('speechSynthesis' in window)) return;
          window.speechSynthesis.cancel();
          const u = new SpeechSynthesisUtterance(text);
          u.rate = this.state.age === 'seedling' ? 0.92 : 1.0;
          u.pitch = 1.05;
          u.volume = this.state.prefs.sound ? 1 : 0.0;
          window.speechSynthesis.speak(u);
        }catch(e){
          console.warn('speech failed', e);
        }
      },

      // --- preferences ---
      togglePref(key){
        this.state.prefs[key] = !this.state.prefs[key];
        this.save();
        this.syncPrefButtons();
        this.sfx('tap');
        if(key === 'voiceCoach' && this.state.prefs.voiceCoach){
          this.speak('Voice Coach is on. Open a game and press Explain for step-by-step help.');
        }
      },

      setAvatar(emoji){
        this.state.user.avatar = emoji;
        this.save();
        this.render();
        this.updateTopUI();
        this.sfx('success');
        this.confetti();
      },

      setAge(age){
        this.state.age = age;
        this.save();
        this.render();
        this.sfx('tap');
        this.openHelp('age', 'Age Group set', `You are now in ${age} mode.`);
      },

      // --- daily streak ---
      ensureDailyReset(){
        const today = new Date().toDateString();
        const last = localStorage.getItem('athena-last-visit');

        if(last !== today){
          const yesterday = new Date();
          yesterday.setDate(yesterday.getDate() - 1);

          if(last === yesterday.toDateString()) this.state.user.streak = (this.state.user.streak || 0) + 1;
          else this.state.user.streak = 1;

          // reset daily
          this.state.daily.done = 0;
          this.state.daily.lastDay = today;

          localStorage.setItem('athena-last-visit', today);
          this.save();
        }
      },

      // --- points & logging ---
      addPoints(pts, reason=''){
        this.state.user.points += pts;
        this.state.user.totalPoints += pts;
        this.state.user.level = Math.max(1, 1 + Math.floor(this.state.user.totalPoints / 300));

        this.state.activity.unshift({
          t: Date.now(),
          text: reason || `+${pts} points`,
          pts
        });
        this.state.activity = this.state.activity.slice(0, 12);

        this.updateTopUI();
        this.save();
      },

      markGameDone(gameId, scoreText){
        this.state.user.gamesPlayed += 1;
        this.state.daily.done = Math.min(this.state.daily.goal, this.state.daily.done + 1);
        this.state.activity.unshift({ t: Date.now(), text: scoreText || `Played ${gameId}`, pts: 0 });
        this.state.activity = this.state.activity.slice(0, 12);
        this.save();
        this.updateTopUI();
        this.updateChallengeUI();
      },

      rank(){
        const p = this.state.user.totalPoints;
        if(p >= 8000) return 'Master';
        if(p >= 4000) return 'Expert';
        if(p >= 1500) return 'Advanced';
        if(p >= 500) return 'Intermediate';
        return 'Beginner';
      },

      renderActivity(){
        const el = document.getElementById('activity-list');
        if(!el) return;
        if(!this.state.activity.length){
          el.innerHTML = '<div class="text-sm text-slate-600">No activity yet. Play a game!</div>';
          return;
        }
        el.innerHTML = this.state.activity.map(a=>{
          const mins = Math.max(0, Math.round((Date.now()-a.t)/60000));
          const when = mins < 1 ? 'just now' : `${mins}m ago`;
          return `<div class="pill rounded-2xl px-4 py-3 flex items-center justify-between"><div><div class="font-extrabold">${this.escape(a.text)}</div><div class="text-xs text-slate-600">${when}</div></div><div class="font-extrabold">${a.pts ? (a.pts>0?`+${a.pts}`:a.pts):''}</div></div>`;
        }).join('');
      },

      seedReviews(){
        const now = Date.now();
        const samples = [
          {skill:'Colors (blue vs red)', due: now + 60*1000},
          {skill:'Add within 10', due: now + 5*60*1000},
          {skill:'Letter A tracing', due: now + 30*60*1000},
          {skill:'Whack even numbers', due: now + 2*60*60*1000},
        ];
        this.state.reviews = samples;
        this.save();
        this.render();
      },

      renderReviews(){
        const el = document.getElementById('review-list');
        if(!el) return;
        if(!this.state.reviews.length){
          el.innerHTML = '<div class="text-sm text-slate-600">No reviews queued yet (demo). Tap ‚ÄúGenerate sample‚Äù.</div>';
          return;
        }
        el.innerHTML = this.state.reviews.map(r=>{
          const mins = Math.max(0, Math.round((r.due - Date.now())/60000));
          const due = mins <= 0 ? 'Due now' : `Due in ${mins}m`;
          return `<div class="pill rounded-2xl px-4 py-3 flex items-center justify-between"><div><div class="font-extrabold">${this.escape(r.skill)}</div><div class="text-xs text-slate-600">${due}</div></div><button class="btn btn-primary" onclick="app.startReview('${this.escapeAttr(r.skill)}')">Review</button></div>`;
        }).join('');
      },

      startReview(skill){
        // lightweight: pick a matching game
        if(skill.toLowerCase().includes('letter') || skill.toLowerCase().includes('trace')) this.startGame('tracing');
        else if(skill.toLowerCase().includes('add') || skill.toLowerCase().includes('math')) this.startGame('math');
        else if(skill.toLowerCase().includes('whack')) this.startGame('whack');
        else this.startGame('tea');
        this.openHelp('app', 'Micro-review', `Great. This is a quick review for: ${skill}.\n\nJust 1‚Äì2 minutes helps memory stick.`);
      },

      // --- game modal management ---
      startGame(id){
        if(this.activeModalEl) this.closeGame();
        const tpl = document.getElementById(`game-${id}`);
        if(!tpl){
          this.openHelp('app', 'Not ready', 'That module is not installed in this demo build.');
          return;
        }
        const wrap = document.createElement('div');
        wrap.innerHTML = tpl.innerHTML;
        const node = wrap.firstElementChild;
        document.body.appendChild(node);
        this.activeModalEl = node;

        this.sfx('tap');

        // init
        const inits = {
          memory: ()=>this.mmInit(),
          tracing: ()=>this.trInit(),
          math: ()=>this.mInit(),
          tea: ()=>this.teaInit(),
          whack: ()=>this.whInit(),
          potty: ()=>this.ptInit(),
        };
        (inits[id]||(()=>{}))();
      },

      closeGame(){
        // cleanup timers/rafs
        this.timers.forEach(id=>clearInterval(id));
        this.timers.clear();
        this.rafs.forEach(id=>cancelAnimationFrame(id));
        this.rafs.clear();

        // stop speech
        try{ if('speechSynthesis' in window) window.speechSynthesis.cancel(); }catch(e){}

        // remove modal
        if(this.activeModalEl){
          this.activeModalEl.remove();
          this.activeModalEl = null;
        }
        this.sfx('tap');
        this.render();
        this.updateTopUI();
      },

      // --- SFX (WebAudio, stable) ---
      audio(){
        if(!this._audioCtx){
          const Ctx = window.AudioContext || window.webkitAudioContext;
          if(!Ctx) return null;
          this._audioCtx = new Ctx();
        }
        return this._audioCtx;
      },

      sfx(type){
        if(!this.state.prefs.sound) return;
        const ctx = this.audio();
        if(!ctx) return;
        const now = ctx.currentTime;
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.connect(g); g.connect(ctx.destination);

        const env = (attack, decay, freqStart, freqEnd)=>{
          o.frequency.setValueAtTime(freqStart, now);
          o.frequency.exponentialRampToValueAtTime(freqEnd, now + decay);
          g.gain.setValueAtTime(0.0001, now);
          g.gain.exponentialRampToValueAtTime(0.20, now + attack);
          g.gain.exponentialRampToValueAtTime(0.0001, now + decay);
        };

        if(type === 'tap'){
          o.type = 'triangle';
          env(0.005, 0.07, 420, 220);
        } else if(type === 'success'){
          o.type = 'sine';
          env(0.01, 0.18, 660, 990);
        } else if(type === 'error'){
          o.type = 'square';
          env(0.005, 0.12, 180, 90);
        } else if(type === 'pop'){
          o.type = 'sine';
          env(0.005, 0.10, 520, 780);
        } else if(type === 'water'){
          o.type = 'sine';
          env(0.01, 0.22, 260, 160);
        } else {
          o.type = 'sine';
          env(0.005, 0.10, 440, 440);
        }

        o.start(now);
        o.stop(now + 0.25);
      },

      haptic(ms=12){
        if(!this.state.prefs.haptics) return;
        if(navigator.vibrate) navigator.vibrate(ms);
      },

      // --- particles ---
      confetti(){
        for(let i=0;i<12;i++){
          const p = document.createElement('div');
          p.className = 'particle';
          const x = Math.random()*window.innerWidth;
          const y = window.innerHeight*0.35 + Math.random()*80;
          p.style.left = `${x}px`;
          p.style.top = `${y}px`;
          p.style.width = '10px';
          p.style.height = '10px';
          p.style.borderRadius = '999px';
          p.style.background = `hsl(${Math.random()*360} 90% 60%)`;
          p.style.animation = 'pop 900ms ease-out forwards';
          document.body.appendChild(p);
          setTimeout(()=>p.remove(), 950);
        }
      },

      // --- quick start ---
      quickStart(){
        const mix = ['tea','whack','tracing','math','memory'];
        const pick = mix[Math.floor(Math.random()*mix.length)];
        this.startGame(pick);
        this.openHelp('app', 'Quick Start', 'You‚Äôll play a short mixed session. Mixing games builds deeper learning.');
      },

      // --- escape helpers ---
      escape(str){
        return String(str)
          .replaceAll('&','&amp;')
          .replaceAll('<','&lt;')
          .replaceAll('>','&gt;')
          .replaceAll('"','&quot;')
          .replaceAll("'",'&#039;');
      },
      escapeAttr(str){
        return this.escape(str).replaceAll('`','');
      },

      // =====================
      // GAME: MEMORY MATCH
      // =====================
      mm: null,
      mmInit(){
        const emojis = ['üê≥','ü¶ä','ü¶Ñ','üê∏','üßÅ','üçâ','üåà','‚≠ê'];
        const deck = [...emojis, ...emojis].sort(()=>Math.random()-0.5);
        this.mm = {
          deck,
          flipped: [],
          matched: new Set(),
          moves: 0,
          start: Date.now(),
          locked: false
        };

        const grid = document.getElementById('mm-grid');
        grid.innerHTML = '';
        deck.forEach((emoji, idx)=>{
          const btn = document.createElement('button');
          btn.className = 'glass rounded-2xl aspect-square grid place-items-center border border-black/5 bg-white/60';
          btn.innerHTML = `<div class="text-2xl sm:text-3xl" data-face="down">‚ùì</div>`;
          btn.setAttribute('aria-label', 'Memory card');
          btn.addEventListener('click', ()=>this.mmFlip(idx, btn));
          grid.appendChild(btn);
        });

        document.getElementById('mm-moves').textContent = '0';
        document.getElementById('mm-matches').textContent = '0';
        document.getElementById('mm-time').textContent = '00:00';

        const timer = setInterval(()=>{
          if(!this.mm) return;
          const s = Math.floor((Date.now() - this.mm.start)/1000);
          const m = String(Math.floor(s/60)).padStart(2,'0');
          const ss = String(s%60).padStart(2,'0');
          const el = document.getElementById('mm-time');
          if(el) el.textContent = `${m}:${ss}`;
        }, 1000);
        this.timers.add(timer);

        if(this.state.prefs.voiceCoach){
          this.speak('Memory Match. Flip two cards to find pairs.');
        }
      },

      mmFlip(idx, btn){
        if(!this.mm || this.mm.locked) return;
        if(this.mm.matched.has(idx)) return;
        if(this.mm.flipped.includes(idx)) return;

        const face = btn.querySelector('div');
        face.textContent = this.mm.deck[idx];
        face.dataset.face = 'up';
        btn.classList.add('ring-2','ring-sky-300');
        this.sfx('tap');

        this.mm.flipped.push(idx);

        if(this.mm.flipped.length === 2){
          this.mm.locked = true;
          this.mm.moves += 1;
          document.getElementById('mm-moves').textContent = String(this.mm.moves);

          const [a,b] = this.mm.flipped;
          const match = this.mm.deck[a] === this.mm.deck[b];
          const cards = Array.from(document.querySelectorAll('#mm-grid > button'));

          setTimeout(()=>{
            if(!this.mm) return;
            if(match){
              this.mm.matched.add(a); this.mm.matched.add(b);
              document.getElementById('mm-matches').textContent = String(this.mm.matched.size/2);
              this.sfx('success');
              this.haptic(18);
              this.confetti();

              // mark matched styling
              [a,b].forEach(i=>{
                const c = cards[i];
                c.classList.remove('ring-2','ring-sky-300');
                c.classList.add('opacity-80');
              });

              if(this.mm.matched.size === this.mm.deck.length){
                this.addPoints(80, 'Won Memory Match');
                this.markGameDone('Memory Match', 'Completed Memory Match');
                this.openHelp('memory', 'Great job!', `You finished in ${this.mm.moves} moves.\n\nStrategy tip: say each picture name out loud to remember it.`);
                this.sfx('success');
              }
            } else {
              this.sfx('error');
              this.haptic(10);
              [a,b].forEach(i=>{
                const c = cards[i];
                const f = c.querySelector('div');
                f.textContent = '‚ùì';
                f.dataset.face = 'down';
                c.classList.remove('ring-2','ring-sky-300');
                c.classList.add('shake');
                setTimeout(()=>c.classList.remove('shake'), 380);
              });
            }
            this.mm.flipped = [];
            this.mm.locked = false;
          }, 650);
        }
      },

      mmNew(){
        this.sfx('tap');
        this.mmInit();
      },

      mmHint(){
        if(!this.mm) return;
        const gridBtns = Array.from(document.querySelectorAll('#mm-grid > button'));
        this.sfx('tap');
        // reveal all briefly
        gridBtns.forEach((btn,i)=>{
          if(this.mm.matched.has(i)) return;
          btn.querySelector('div').textContent = this.mm.deck[i];
        });
        setTimeout(()=>{
          if(!this.mm) return;
          gridBtns.forEach((btn,i)=>{
            if(this.mm.matched.has(i)) return;
            if(this.mm.flipped.includes(i)) return;
            btn.querySelector('div').textContent = '‚ùì';
          });
        }, 700);
      },

      // =====================
      // GAME: TRACING
      // =====================
      tr: null,
      trInit(){
        this.tr = {
          mode: 'letters',
          index: 0,
          score: 0,
          drawing: false,
          last: null,
          pointsDrawn: 0,
        };

        this.trSetMode('letters');
        this.trSetupCanvas();

        if(this.state.prefs.voiceCoach){
          this.speak('Tracing Studio. Trace the dotted guide and press check.');
        }
      },

      trSetMode(mode){
        if(!this.tr) this.tr = { mode, index:0, score:0 };
        this.tr.mode = mode;
        this.tr.index = 0;
        const ids = ['letters','numbers','shapes'];
        ids.forEach(k=>{
          const b = document.getElementById(`tr-btn-${k}`);
          if(b) b.classList.toggle('btn-primary', k===mode);
        });
        this.trLoadChar();
        this.trClear();
        this.sfx('tap');
      },

      trChars(){
        return {
          letters: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split(''),
          numbers: '0123456789'.split(''),
          shapes: ['‚óØ','‚ñ≥','‚ñ°','‚òÖ','‚ô•']
        };
      },

      trLoadChar(){
        const char = this.trChars()[this.tr.mode][this.tr.index % this.trChars()[this.tr.mode].length];
        const el = document.getElementById('tr-char');
        if(el) el.textContent = char;
        // redraw guide
        this.trDrawGuide();
      },

      trSetupCanvas(){
        const canvas = document.getElementById('tr-canvas');
        if(!canvas) return;
        const ctx = canvas.getContext('2d');

        const resize = ()=>{
          const dpr = window.devicePixelRatio || 1;
          const rect = canvas.getBoundingClientRect();
          canvas.width = Math.max(1, Math.floor(rect.width * dpr));
          canvas.height = Math.max(1, Math.floor(rect.height * dpr));
          ctx.setTransform(dpr,0,0,dpr,0,0);
          this.trDrawGuide();
        };

        resize();
        const r = setInterval(()=>{
          // keep stable on rotation
          resize();
        }, 1200);
        this.timers.add(r);

        const onDown = (e)=>{
          this.tr.drawing = true;
          this.tr.last = this.trPoint(canvas, e);
          this.sfx('tap');
        };
        const onMove = (e)=>{
          if(!this.tr.drawing) return;
          const p = this.trPoint(canvas, e);
          this.trDrawStroke(this.tr.last, p);
          this.tr.last = p;
          this.tr.pointsDrawn += 1;
        };
        const onUp = ()=>{
          this.tr.drawing = false;
          this.tr.last = null;
        };

        canvas.addEventListener('pointerdown', onDown);
        canvas.addEventListener('pointermove', onMove);
        canvas.addEventListener('pointerup', onUp);
        canvas.addEventListener('pointercancel', onUp);
        canvas.addEventListener('pointerleave', onUp);

        this.tr._cleanup = ()=>{
          canvas.removeEventListener('pointerdown', onDown);
          canvas.removeEventListener('pointermove', onMove);
          canvas.removeEventListener('pointerup', onUp);
          canvas.removeEventListener('pointercancel', onUp);
          canvas.removeEventListener('pointerleave', onUp);
        };
      },

      trPoint(canvas, e){
        const rect = canvas.getBoundingClientRect();
        return { x: e.clientX - rect.left, y: e.clientY - rect.top };
      },

      trCtx(){
        const canvas = document.getElementById('tr-canvas');
        if(!canvas) return null;
        return canvas.getContext('2d');
      },

      trDrawGuide(){
        const canvas = document.getElementById('tr-canvas');
        const ctx = this.trCtx();
        if(!canvas || !ctx) return;

        // clear
        ctx.clearRect(0,0,canvas.width,canvas.height);

        // background
        const rect = canvas.getBoundingClientRect();
        ctx.save();
        ctx.setTransform(1,0,0,1,0,0);
        ctx.fillStyle = 'rgba(255,255,255,1)';
        ctx.fillRect(0,0,rect.width,rect.height);
        ctx.restore();

        // dotted guide
        const char = document.getElementById('tr-char')?.textContent || 'A';
        const w = rect.width;
        const h = rect.height;

        ctx.save();
        ctx.setTransform(1,0,0,1,0,0);
        ctx.fillStyle = 'rgba(15,23,42,.10)';
        ctx.font = `900 ${Math.floor(Math.min(w,h)*0.55)}px Fredoka`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.setLineDash([8,8]);
        ctx.lineWidth = 4;
        ctx.strokeStyle = 'rgba(96,165,250,.55)';
        ctx.strokeText(char, w/2, h/2);
        ctx.fillText(char, w/2, h/2);
        ctx.restore();

        // reset points
        if(this.tr) this.tr.pointsDrawn = 0;
      },

      trDrawStroke(a,b){
        const ctx = this.trCtx();
        if(!ctx) return;
        ctx.save();
        ctx.setTransform(1,0,0,1,0,0);
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.strokeStyle = 'rgba(251,113,133,.95)';
        ctx.lineWidth = this.state.age === 'seedling' ? 10 : 7;
        ctx.beginPath();
        ctx.moveTo(a.x,a.y);
        ctx.lineTo(b.x,b.y);
        ctx.stroke();
        ctx.restore();
      },

      trClear(){
        if(!this.tr) return;
        this.trDrawGuide();
        this.sfx('tap');
      },

      trNext(){
        if(!this.tr) return;
        this.tr.index += 1;
        this.trLoadChar();
        this.trClear();
        this.sfx('tap');
      },

      trCheck(){
        if(!this.tr) return;
        // simple reliability metric: did the child draw enough segments?
        const need = this.state.age === 'seedling' ? 40 : 70;
        if(this.tr.pointsDrawn >= need){
          this.tr.score += 1;
          document.getElementById('tr-score').textContent = String(this.tr.score);
          this.addPoints(20, 'Tracing success');
          this.markGameDone('Tracing', 'Completed a tracing');
          this.sfx('success');
          this.haptic(18);
          this.confetti();

          const char = document.getElementById('tr-char')?.textContent;
          const msg = `Nice tracing! You practiced: ${char}.\n\nBrain tip: slow, careful lines build stronger motor memory.`;
          if(this.state.prefs.voiceCoach) this.speak(msg);
          this.openHelp('tracing', 'Great tracing!', msg);
          this.trNext();
        } else {
          this.sfx('error');
          this.haptic(10);
          const msg = "Almost! Try tracing a little more of the dotted guide.\n\nTip: go slow and follow the outline.";
          this.openHelp('tracing', 'Keep going', msg);
        }
      },

      // =====================
      // GAME: MATH
      // =====================
      m: null,
      mInit(){
        this.m = { score:0, level:1, streak:0, prob:null };
        this.mNext();
        if(this.state.prefs.voiceCoach){
          this.speak('Math Adventure. Choose the correct answer. Use the hint if needed.');
        }
      },

      mMake(){
        const lvl = this.m.level;
        let a,b,op,ans;
        if(lvl <= 2){
          a = this.rand(1,10); b = this.rand(1,10); op = '+'; ans = a+b;
        } else if(lvl <= 4){
          a = this.rand(1,20); b = this.rand(1,20);
          op = Math.random() > .5 ? '+' : '-';
          ans = op==='+'? a+b : a-b;
        } else {
          a = this.rand(2,12); b = this.rand(2,12); op='√ó'; ans = a*b;
        }
        // keep subtraction positive for kid-friendly
        if(op==='-' && ans < 0){ [a,b]=[b,a]; ans = a-b; }

        const opts = new Set([ans]);
        while(opts.size < 4){
          const delta = this.rand(-6,6);
          const w = ans + delta;
          if(w>0) opts.add(w);
        }
        const options = Array.from(opts).sort(()=>Math.random()-0.5);
        return {a,b,op,ans,options};
      },

      mNext(){
        this.m.prob = this.mMake();
        document.getElementById('m-score').textContent = String(this.m.score);
        document.getElementById('m-level').textContent = String(this.m.level);
        document.getElementById('m-streak').textContent = String(this.m.streak);
        document.getElementById('m-feedback').textContent = '';

        const {a,b,op,options} = this.m.prob;
        document.getElementById('m-problem').textContent = `${a} ${op} ${b} = ?`;

        const cont = document.getElementById('m-options');
        cont.innerHTML = '';
        options.forEach(v=>{
          const btn = document.createElement('button');
          btn.className = 'btn btn-primary text-2xl font-extrabold';
          btn.textContent = v;
          btn.addEventListener('click', ()=>this.mCheck(v));
          cont.appendChild(btn);
        });

        if(this.state.age === 'seedling' && this.state.prefs.voiceCoach){
          this.speak(`What is ${a} ${op==='√ó'?'times':op==='+'?'plus':'minus'} ${b}?`);
        }
      },

      mCheck(sel){
        const fb = document.getElementById('m-feedback');
        const correct = this.m.prob.ans;
        if(sel === correct){
          this.m.score += 10;
          this.m.streak += 1;
          fb.textContent = 'Correct!';
          fb.className = 'mt-3 text-center font-extrabold text-emerald-600';
          this.sfx('success');
          this.haptic(18);

          if(this.m.score % 50 === 0){
            this.m.level += 1;
            this.confetti();
            this.openHelp('math', 'Level up!', `You reached level ${this.m.level}.`);
          }

          this.addPoints(15, 'Math correct');
          this.markGameDone('Math', 'Solved a math problem');

          setTimeout(()=>this.mNext(), 650);
        } else {
          this.m.streak = 0;
          fb.textContent = `Not quite. The answer is ${correct}.`;
          fb.className = 'mt-3 text-center font-extrabold text-rose-600';
          this.sfx('error');
          this.haptic(10);

          // productive-effort coaching
          const {a,b,op} = this.m.prob;
          const hint = this.mHintText(a,b,op);
          if(this.state.prefs.voiceCoach) this.speak(`Good try. ${hint}`);
          setTimeout(()=>this.mNext(), 950);
        }

        document.getElementById('m-score').textContent = String(this.m.score);
        document.getElementById('m-level').textContent = String(this.m.level);
        document.getElementById('m-streak').textContent = String(this.m.streak);
      },

      mSkip(){
        this.sfx('tap');
        this.mNext();
      },

      mHint(){
        const {a,b,op} = this.m.prob;
        const hint = this.mHintText(a,b,op);
        document.getElementById('m-feedback').textContent = `Hint: ${hint}`;
        document.getElementById('m-feedback').className = 'mt-3 text-center font-extrabold text-sky-700';
        this.sfx('tap');
        if(this.state.prefs.voiceCoach) this.speak(hint);
      },

      mHintText(a,b,op){
        if(op === '+') return `Count up from ${a} by ${b}.`;
        if(op === '-') return `Count down from ${a} by ${b}.`;
        return `Think of ${a} groups of ${b}.`;
      },

      // =====================
      // GAME: TEA PARTY
      // =====================
      tea: null,
      teaInit(){
        this.tea = {
          selected: 'robot',
          round: 1,
          score: 0,
          guests: {
            bear: [],
            robot: [],
            doll: []
          },
          task: null,
        };
        this.teaSelect('robot');
        this.teaNext(true);

        if(this.state.prefs.voiceCoach){
          this.speak('Tea Party. Tap a guest, then add the correct treats to their plate.');
        }
      },

      teaSelect(guest){
        if(!this.tea) return;
        this.tea.selected = guest;
        document.getElementById('tea-selected').textContent = guest[0].toUpperCase()+guest.slice(1);
        ['bear','robot','doll'].forEach(g=>{
          const el = document.getElementById(`g-${g}`);
          if(el){
            el.classList.toggle('ring-2', g===guest);
            el.classList.toggle('ring-sky-300', g===guest);
          }
        });
        this.sfx('tap');
      },

      teaAdd(type, color){
        if(!this.tea) return;
        const g = this.tea.selected;
        this.tea.guests[g].push({type,color});
        this.teaRenderPlate(g);
        this.sfx('tap');
        this.teaCheck();
      },

      teaRenderPlate(guest){
        const plate = document.getElementById(`plate-${guest}`);
        if(!plate) return;
        const items = this.tea.guests[guest];
        plate.innerHTML = items.slice(-6).map(it=>{
          const dot = it.color === 'blue' ? 'üîµ' : it.color === 'red' ? 'üî¥' : 'üü¢';
          return `<span title="${it.color}">üç™${dot}</span>`;
        }).join('');
      },

      teaClearSelected(){
        if(!this.tea) return;
        this.tea.guests[this.tea.selected] = [];
        this.teaRenderPlate(this.tea.selected);
        this.sfx('tap');
      },

      teaMakeTask(){
        const guests = ['bear','robot','doll'];
        const colors = ['blue','red','green'];
        const g = guests[Math.floor(Math.random()*guests.length)];
        const c = colors[Math.floor(Math.random()*colors.length)];
        const n = this.state.age === 'seedling' ? this.rand(1,3) : this.state.age === 'explorer' ? this.rand(1,5) : this.rand(2,7);
        return { guest:g, color:c, count:n, type:'cookie' };
      },

      teaNext(first=false){
        if(!this.tea) return;
        if(!first){
          // metacognitive nudge
          const msg = 'Strategy: tap the guest first, then count each cookie out loud.';
          if(this.state.prefs.voiceCoach) this.speak(msg);
        }
        this.tea.task = this.teaMakeTask();
        this.tea.round += first ? 0 : 1;
        document.getElementById('tea-round').textContent = String(this.tea.round);
        const gName = this.tea.task.guest[0].toUpperCase()+this.tea.task.guest.slice(1);
        const instruction = `Serve the ${gName} ${this.tea.task.count} ${this.tea.task.color} cookies.`;
        document.getElementById('tea-instruction').textContent = instruction;
        if(this.state.prefs.voiceCoach) this.speak(instruction);
        this.sfx('tap');
      },

      teaCheck(){
        if(!this.tea || !this.tea.task) return;
        const {guest, color, count} = this.tea.task;
        const items = this.tea.guests[guest];
        const matching = items.filter(x=>x.color===color).length;
        const wrongColors = items.filter(x=>x.color!==color).length;

        // only check when they changed the target plate
        if(this.tea.selected !== guest) return;

        if(matching === count && wrongColors === 0){
          this.tea.score += 1;
          document.getElementById('tea-score').textContent = String(this.tea.score);
          this.addPoints(25, 'Tea Party round');
          this.markGameDone('Tea Party', 'Completed a tea party round');
          this.sfx('success');
          this.haptic(18);
          this.confetti();

          const msg = `Nice! You served exactly ${count} ${color} cookies to ${guest}.`;
          this.openHelp('tea', 'Correct!', msg);
          // clear just that plate for next round
          this.tea.guests[guest] = [];
          this.teaRenderPlate(guest);
          setTimeout(()=>this.teaNext(), 500);
        } else if(items.length >= count && (wrongColors>0 || matching>count)){
          // gentle feedback
          this.sfx('error');
          this.haptic(10);
          const msg = `Almost. The instruction wants ${count} ${color} cookies for ${guest}.\n\nTry clearing the plate and counting again.`;
          this.openHelp('tea', 'Try again', msg);
        }
      },

      // =====================
      // GAME: WHACK
      // =====================
      wh: null,
      whInit(){
        // build grid
        const grid = document.getElementById('wh-grid');
        grid.innerHTML = '';
        for(let i=0;i<9;i++){
          const hole = document.createElement('div');
          hole.className = 'hole';
          hole.dataset.i = String(i);
          hole.addEventListener('pointerdown', ()=>this.whTap(i));
          grid.appendChild(hole);
        }

        this.wh = {
          running: false,
          time: 30,
          score: 0,
          streak: 0,
          targetIndex: -1,
          targetValue: null,
          targetKind: null,
          spawnEvery: this.state.age === 'seedling' ? 1100 : this.state.age === 'explorer' ? 900 : 750,
          visibleFor: this.state.age === 'seedling' ? 900 : this.state.age === 'explorer' ? 750 : 620,
        };

        document.getElementById('wh-time').textContent = String(this.wh.time);
        document.getElementById('wh-score').textContent = String(this.wh.score);
        document.getElementById('wh-streak').textContent = String(this.wh.streak);
        document.getElementById('wh-instruction').textContent = 'Press Start to begin.';

        if(this.state.prefs.voiceCoach){
          this.speak('Whack-a-Target. Press Start. Then tap the correct target before it hides.');
        }
      },

      whExplain(){
        const msg = this.helpContent().whack.body;
        this.openHelp('whack');
        if(this.state.prefs.voiceCoach) this.speak(msg);
      },

      whMakeInstruction(){
        // seedling: whack the star
        if(this.state.age === 'seedling'){
          return { kind:'emoji', value:'‚≠ê', text:'Whack the STAR ‚≠ê' };
        }
        // explorer: numbers 1-9
        if(this.state.age === 'explorer'){
          const v = String(this.rand(1,9));
          return { kind:'number', value:v, text:`Whack number ${v}` };
        }
        // master: even/odd decision
        const even = Math.random() > 0.5;
        return { kind:'rule', value: even ? 'even' : 'odd', text:`Whack an ${even?'EVEN':'ODD'} number` };
      },

      whStart(){
        if(!this.wh) return;
        if(this.wh.running) return;
        this.wh.running = true;
        this.sfx('tap');

        // countdown
        const tick = setInterval(()=>{
          if(!this.wh || !this.wh.running) return;
          this.wh.time -= 1;
          document.getElementById('wh-time').textContent = String(this.wh.time);
          if(this.wh.time <= 0){
            this.whStop(true);
          }
        }, 1000);
        this.timers.add(tick);

        // spawn loop
        const loop = setInterval(()=>{
          if(!this.wh || !this.wh.running) return;
          this.whSpawn();
        }, this.wh.spawnEvery);
        this.timers.add(loop);

        // initial spawn
        this.whSpawn();
      },

      whStop(finished=false){
        if(!this.wh) return;
        this.wh.running = false;
        this.sfx('tap');
        this.whHide();

        if(finished){
          const pts = Math.max(0, this.wh.score * 5);
          this.addPoints(pts, 'Whack game finished');
          this.markGameDone('Whack', `Whack finished: score ${this.wh.score}`);
          this.confetti();
          const msg = `Time! Your score is ${this.wh.score}.\n\nTip: keep your eyes on the instruction line.`;
          this.openHelp('whack', 'Round complete', msg);
          if(this.state.prefs.voiceCoach) this.speak(msg);
        }
      },

      whSpawn(){
        if(!this.wh) return;
        this.whHide();

        const instruction = this.whMakeInstruction();
        this.wh.targetKind = instruction.kind;
        this.wh.targetValue = instruction.value;
        document.getElementById('wh-instruction').textContent = instruction.text;
        if(this.state.prefs.voiceCoach){
          // keep it short
          this.speak(instruction.text);
        }

        // choose index and value
        const idx = this.rand(0,8);
        this.wh.targetIndex = idx;

        let value;
        if(instruction.kind === 'emoji'){
          value = instruction.value;
        } else if(instruction.kind === 'number'){
          value = instruction.value;
        } else {
          // rule: show a random number and user must decide
          value = String(this.rand(1,9));
        }

        const hole = document.querySelector(`.hole[data-i="${idx}"]`);
        if(!hole) return;

        const mole = document.createElement('div');
        mole.className = 'mole';
        mole.textContent = value;
        hole.appendChild(mole);

        // animate up
        requestAnimationFrame(()=>{
          mole.classList.add('up');
        });

        this.wh._moleEl = mole;
        this.wh._moleValue = value;

        this.sfx('pop');

        // auto hide
        const hideT = setTimeout(()=>{
          if(!this.wh || !this.wh.running) return;
          // missed opportunity
          this.wh.streak = 0;
          document.getElementById('wh-streak').textContent = String(this.wh.streak);
          this.whHide();
        }, this.wh.visibleFor);
        this.timers.add(hideT);
      },

      whHide(){
        if(!this.wh) return;
        const mole = this.wh._moleEl;
        if(mole && mole.parentElement){
          mole.remove();
        }
        this.wh._moleEl = null;
        this.wh._moleValue = null;
        this.wh.targetIndex = -1;
      },

      whTap(i){
        if(!this.wh || !this.wh.running) return;
        const mole = this.wh._moleEl;
        if(!mole) return;

        const correctHole = i === this.wh.targetIndex;
        if(!correctHole){
          // tapped empty/wrong hole
          this.sfx('error');
          this.haptic(8);
          this.wh.streak = 0;
          document.getElementById('wh-streak').textContent = String(this.wh.streak);
          return;
        }

        const val = this.wh._moleValue;
        let correct = false;

        if(this.wh.targetKind === 'emoji'){
          correct = val === '‚≠ê';
        } else if(this.wh.targetKind === 'number'){
          correct = val === this.wh.targetValue;
        } else {
          const n = parseInt(val, 10);
          const wantEven = this.wh.targetValue === 'even';
          correct = wantEven ? (n % 2 === 0) : (n % 2 === 1);
        }

        mole.classList.add('hit');

        if(correct){
          this.wh.score += 1;
          this.wh.streak += 1;
          this.sfx('success');
          this.haptic(16);
          this.confetti();

          // micro-coach
          if(this.wh.streak === 3 && this.state.prefs.voiceCoach){
            this.speak('Nice streak! Keep going.');
          }
        } else {
          this.wh.streak = 0;
          this.sfx('error');
          this.haptic(10);

          const msg = this.state.age === 'master'
            ? 'Close! Look at the instruction: even numbers end in 0,2,4,6,8.'
            : 'Close! Keep your eyes on the instruction line.';
          if(this.state.prefs.voiceCoach) this.speak(msg);
        }

        document.getElementById('wh-score').textContent = String(this.wh.score);
        document.getElementById('wh-streak').textContent = String(this.wh.streak);

        // remove target and spawn next soon
        this.whHide();
      },

      // =====================
      // GAME: POTTY
      // =====================
      pt: null,
      ptInit(){
        this.pt = {
          step: 0,
          stars: 0,
          routineStreak: this.state.user.streak,
          today: 0,
          washing: false,
          washLeft: 0,
        };
        this.ptRender();
        if(this.state.prefs.voiceCoach){
          this.speak('Potty Routine. We will practice: go, wipe, flush, and wash hands.');
        }
      },

      ptSteps(){
        return [
          { title:'1) Go potty', coach:'Great noticing your body. Take a calm breath.', sfx:'tap' },
          { title:'2) Wipe', coach:'Wipe gently and carefully. Ask a grown-up if you need help.', sfx:'tap' },
          { title:'3) Flush', coach:'Flush! Watch the water spin.', sfx:'water' },
          { title:'4) Wash hands (20 seconds)', coach:'Soap + scrub for 20 seconds. Bubbles mean you‚Äôre cleaning!', sfx:'water' },
          { title:'5) All done!', coach:'High five! You completed the routine.', sfx:'success' },
        ];
      },

      ptRender(){
        const s = this.ptSteps()[this.pt.step];
        document.getElementById('pt-step').textContent = s.title;
        document.getElementById('pt-coach').textContent = s.coach;
        document.getElementById('pt-stepnum').textContent = String(this.pt.step + 1);
        document.getElementById('pt-stars').textContent = String(this.pt.stars);
        document.getElementById('pt-streak').textContent = String(this.pt.routineStreak);
        document.getElementById('pt-today').textContent = String(this.pt.today);
      },

      ptExplain(){
        const s = this.ptSteps()[this.pt.step];
        const msg = `${s.title}. ${s.coach}`;
        this.openHelp('potty', 'Coach says', msg);
        if(this.state.prefs.voiceCoach) this.speak(msg);
      },

      ptDoStep(){
        if(!this.pt) return;
        const s = this.ptSteps()[this.pt.step];
        this.sfx(s.sfx);

        // animate simple imagery
        const stream = document.getElementById('pt-stream');
        const bubbles = document.getElementById('pt-bubbles');
        const water = document.getElementById('pt-water');

        if(this.pt.step === 2 && water){
          // flush wiggle
          water.setAttribute('opacity', '0.65');
          setTimeout(()=>water.setAttribute('opacity','0.25'), 500);
        }

        if(this.pt.step === 3){
          // washing hands timer
          if(this.pt.washing) return;
          this.pt.washing = true;
          this.pt.washLeft = 20;

          if(stream){
            stream.setAttribute('height', '90');
            stream.setAttribute('y', '38');
          }
          if(bubbles) bubbles.setAttribute('opacity', '1');

          const t = setInterval(()=>{
            if(!this.pt) return;
            this.pt.washLeft -= 1;
            document.getElementById('pt-coach').textContent = `Scrub‚Ä¶ ${this.pt.washLeft}s left`;
            if(this.pt.washLeft <= 0){
              clearInterval(t);
              this.timers.delete(t);
              this.pt.washing = false;
              if(stream){
                stream.setAttribute('height', '0');
              }
              if(bubbles) bubbles.setAttribute('opacity', '0');
              this.ptCompleteStep();
            }
          }, 1000);
          this.timers.add(t);
          return;
        }

        this.ptCompleteStep();
      },

      ptCompleteStep(){
        this.pt.stars += 1;
        this.pt.today += 1;
        this.addPoints(10, 'Potty routine practice');
        this.markGameDone('Potty', 'Practiced potty routine');
        this.confetti();
        this.haptic(12);

        if(this.pt.step < this.ptSteps().length - 1){
          this.pt.step += 1;
          this.ptRender();
          if(this.state.prefs.voiceCoach) this.speak(this.ptSteps()[this.pt.step].coach);
        }
      },

      ptNext(){
        if(!this.pt) return;
        if(this.pt.step < this.ptSteps().length - 1){
          this.pt.step += 1;
          this.ptRender();
          this.sfx('tap');
        } else {
          this.sfx('success');
          const msg = 'You completed the potty routine. Great job building a habit!';
          this.openHelp('potty', 'All done!', msg);
          if(this.state.prefs.voiceCoach) this.speak(msg);
        }
      },

      // --- utils ---
      rand(min,max){
        return Math.floor(Math.random()*(max-min+1))+min;
      }
    };

    // Boot
    if(document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', ()=>app.init());
    } else {
      app.init();
    }

    // PWA SW (tiny offline shell)
    if('serviceWorker' in navigator){
      const sw = `
        const CACHE='athena-v2';
        self.addEventListener('install', e=>{
          e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./'])));
        });
        self.addEventListener('fetch', e=>{
          e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)));
        });
      `;
      navigator.serviceWorker.register(URL.createObjectURL(new Blob([sw], {type:'text/javascript'})))
        .catch(()=>{});
    }

    // Install prompt
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e)=>{
      e.preventDefault();
      deferredPrompt = e;
      setTimeout(()=>{
        if(!deferredPrompt) return;
        const btn = document.createElement('button');
        btn.className = 'btn btn-primary fixed right-4 bottom-28 z-50';
        btn.innerHTML = '<i class="fa-solid fa-download mr-2"></i>Install';
        btn.onclick = async ()=>{
          try{
            deferredPrompt.prompt();
            const choice = await deferredPrompt.userChoice;
            if(choice.outcome === 'accepted') btn.remove();
          }catch(_e){}
          deferredPrompt = null;
        };
        document.body.appendChild(btn);
      }, 2500);
    });
  </script>
</body>
</html>
